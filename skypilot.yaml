# YAML doc : https://skypilot.readthedocs.io/en/latest/reference/yaml-spec.html

resources:
  cloud: aws
  # 1x NVIDIA A10G GPU
  accelerators: A10G:1
  instance_type: g5.xlarge
  region: eu-west-1
  # use_spot: true
  image_id: ami-0e174c3e9fa61e692 # Deep Learning AMI GPU PyTorch 2.0.0 (Ubuntu 20.04) in eu-west-1

# Working directory (optional) containing the project codebase.
# Its contents are synced to ~/sky_workdir/ on the cluster.
workdir: .

file_mounts:
  ~/.ssh/config: .sky_ssh_config
  ~/.zshrc: .sky_zshrc
  ~/.netrc: ~/.netrc

  # See SkyPilot storage doc to make storage of large files (datasets, models, artifacts)
  # faster and persist across runs using S3:
  # https://sky-proj-sky.readthedocs-hosted.com/en/latest/reference/storage.html#sky-storage


# Invoked under the workdir (i.e., can use its files).
setup: |
  echo "Running setup."
  # Install zsh, oh-my-zsh and plugins
  sudo apt install zsh -y &> /tmp/zsh_install.log
  bash -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended --keep-zshrc &> /tmp/ohmyzsh_install.log
  git clone -q https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting
  git clone -q https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions
  sudo chsh -s /bin/zsh ubuntu
  
  # Install ml-detector virtual environment
  export PYPI_HOST="gitlab.gitguardian.ovh/api/v4/projects/435/packages/pypi"
  chown ubuntu ~/.netrc & chmod 0600 ~/.netrc
  source activate pytorch && pip install -q pipenv && pipenv install --dev

# Typical use: make use of resources, such as running training.
# Invoked under the workdir (i.e., can use its files).
run: |
  echo "Hello, SkyPilot!"
  conda env list
